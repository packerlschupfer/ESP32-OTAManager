; PlatformIO Project Configuration File
;
; Build options: build flags, source filter
; Upload options: custom upload port, speed and extra flags
; Library options: dependencies, extra library storages
; Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html
; ESP32 Ethernet-only (LAN8720), Arduino core 3.3.x (2025 blueprint)

[platformio]
default_envs = esp32dev_usb_debug

; -------------------------------------------------------------------
; Shared Environment Settings
[env_defaults]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
framework = arduino
board = esp32dev
; board_build.partitions = default_8MB.csv ; if supported by board variant

platform_packages =
    tool-openocd-esp32@^2.1200.20230419

; Additional libraries needed for Arduino 3.x
lib_ignore = 
    WiFi

monitor_port = /dev/ttyACM0
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
check_skip_packages = yes
; board_build.flash_mode = qio
; board_build.partitions = huge_app.csv
; board_build.partitions = default.csv

; library dependency finder mode
lib_ldf_mode = deep+

; Project libraries using git+file protocol
lib_deps = 
    ; Core utilities
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-Logger#remove_esp_log_redirect
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-SemaphoreGuard
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-MutexGuard
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-Watchdog
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-TaskManager#optimized-default
    
    ; Network
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-EthernetManager
    git+file:///home/mrnice/Documents/PlatformIO/libs/workspace_Class-OTAManager

; -------------------------------------------------------------------
; Base build flags
[base]
build_flags = 
    -Wall ; Enable all warnings
    ; -flto
    ; -ffat-lto-objects
    ; -fuse-linker-plugin
    # For more aggressive optimization (optional)
    ; -flto=auto
    ; -ffat-lto-objects
    ; -fuse-linker-plugin
    ; -O3

    -flto=auto                   ; Use all available CPU cores for LTO
    -ffat-lto-objects            ; Generate both LTO and regular object code
    -fuse-linker-plugin          ; Use LTO plugin during linking
    -O3                          ; Maximum optimization level
    -ffunction-sections          ; Place each function in separate section
    -fdata-sections              ; Place each data item in separate section
    -Wl,--gc-sections            ; Remove unused sections at link time
    ; -fno-rtti                    ; Disable RTTI if not needed
    -fno-exceptions              ; Disable exceptions if not needed
    -fmerge-all-constants        ; Merge identical constants
    -fdevirtualize-speculatively ; Aggressive devirtualization
    -finline-functions           ; Inline functions aggressively
    -funroll-loops               ; Unroll loops for performance
    -fomit-frame-pointer         ; Omit frame pointer for better optimization

    ; aggresive
    ; -flto=auto
    ; -O3
    ; -ffast-math                ; Fast floating point (may reduce precision)
    ; -march=native              ; Optimize for specific CPU (ESP32 specific)
    ; -mtune=native              ; Tune for specific CPU
    ; -fwhole-program            ; Assume whole program visibility


    -std=gnu++17 ; Specify C++ standard
    -D CONFIG_ETH_ENABLED=1 ; IMPORTANT for ETH to work (solves Network.h/SPI.h issues)
    -D CONFIG_WIFI_ENABLED=0 ; Disable WiFi support in OTAManager
    -D CONFIG_MDNS_DISABLE=1
    ; Project-specific configuration
    -D DEVICE_HOSTNAME=\"esp32-ethernet-device\"
    -D ETH_PHY_MDC_PIN=23
    -D ETH_PHY_MDIO_PIN=18
    -D ETH_PHY_ADDR=0
    -D ETH_PHY_POWER_PIN=-1
    -D STATUS_LED_PIN=2
    -D OTA_PASSWORD=\"update-password\"

; Optional strict WiFi removal:
; -D SOC_WIFI_SUPPORTED=0
; -D CONFIG_ARDUINO_WIFI_ENABLE=0

; Completely disable WiFi
; -D CONFIG_WIFI_ENABLED=0
; -D CONFIG_ARDUINO_WIFI_ENABLE=0
; -D SOC_WIFI_SUPPORTED=0
; -D CONFIG_BT_ENABLED=0
; -D CONFIG_BLUEDROID_ENABLED=0
; -D CONFIG_BT_SOC_SUPPORT_5_0=0

; -------------------------------------------------------------------
[base_debug]
build_type = debug
build_flags = 
    ${base.build_flags}
    -DCMAKE_BUILD_TYPE=debug
    -DMAIN_DEBUG
    -DETH_DEBUG
    -DOTA_DEBUG
    -DCONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=1
    -DconfigUSE_TRACE_FACILITY=1
    -DCORE_DEBUG_LEVEL=5         ; Enable verbose logging
    -O0                          ; Disable optimizations
    -g3                          ; Detailed debugging info
    -ggdb3                       ; Debugging info for GDB
    -Wl,--undefined=uxTopUsedPriority ; Ensure uxTopUsedPriority is not discarded

[base_release]
build_flags =
    ${base.build_flags}
    -Os                          ; Optimize for size
    -Werror                      ; Treat warnings as errors
    ; -DNDEBUG                   ; Uncomment to disable assert() calls

; -------------------------------------------------------------------
; USB Debug Configuration
[env:esp32dev_usb_debug]
extends = env_defaults, base_debug
upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; USB Release Configuration
[env:esp32dev_usb_release]
extends = env_defaults, base_release
upload_port = /dev/ttyACM0
upload_speed = 921600
; board_build.flash_mode = qio

; -------------------------------------------------------------------
; OTA Debug Configuration
[env:esp32dev_ota_debug]
extends = env_defaults, base_debug
upload_protocol = espota
upload_port = 192.168.16.138
upload_flags = 
    --host_ip=192.168.16.16
    --auth=update-password

; -------------------------------------------------------------------
; OTA Release Configuration
[env:esp32dev_ota_release]
extends = env_defaults, base_release
upload_protocol = espota
upload_port = 192.168.16.138
upload_flags = 
    --host_ip=192.168.16.16
    --auth=update-password
