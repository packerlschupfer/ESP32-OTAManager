; PlatformIO configuration for OTAManager with FreeRTOS
; Optimized for multi-threaded applications

[env:esp32-ota-freertos]
platform = espressif32
board = esp32dev
framework = arduino

lib_deps = 
    OTAManager

; FreeRTOS and threading optimizations
build_flags = 
    -D CORE_DEBUG_LEVEL=3
    ; FreeRTOS configuration
    -D CONFIG_FREERTOS_HZ=1000
    -D CONFIG_FREERTOS_ASSERT_ON_UNTESTED_FUNCTION=1
    -D CONFIG_FREERTOS_CHECK_STACKOVERFLOW=2
    -D CONFIG_FREERTOS_WATCHPOINT_END_OF_STACK=1
    -D CONFIG_FREERTOS_THREAD_LOCAL_STORAGE_POINTERS=3
    ; Task priorities
    -D OTA_TASK_PRIORITY=1
    -D APP_TASK_PRIORITY=2
    -D MONITOR_TASK_PRIORITY=3
    ; Stack sizes
    -D OTA_TASK_STACK_SIZE=4096
    -D APP_TASK_STACK_SIZE=8192
    ; Core affinity
    -D OTA_TASK_CORE=0
    -D APP_TASK_CORE=1
    ; OTA configuration
    -D OTA_HOSTNAME=\"esp32-rtos\"
    -D OTA_PASSWORD=\"rtos123\"
    -D OTA_PORT=3232
    ; Enable mutex debugging
    -D CONFIG_FREERTOS_PORTMUX_DEBUG=1

; Increased stack for complex applications
board_build.stack_size = 8192

; Monitor configuration
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    colorize
    time

; Initial upload
upload_speed = 921600

; OTA configuration
upload_protocol = espota
upload_port = esp32-rtos.local
upload_flags = 
    --port=3232
    --auth=rtos123

; Custom FreeRTOS environment with task monitoring
[env:esp32-ota-freertos-debug]
extends = env:esp32-ota-freertos
build_type = debug
build_flags = 
    ${env:esp32-ota-freertos.build_flags}
    -D CONFIG_FREERTOS_GENERATE_RUN_TIME_STATS=1
    -D CONFIG_FREERTOS_USE_TRACE_FACILITY=1
    -D CONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=1
    -D INCLUDE_uxTaskGetStackHighWaterMark=1
    -D INCLUDE_xTaskGetIdleTaskHandle=1
    -D DEBUG_TASK_SWITCHING
    
; Memory optimized FreeRTOS configuration
[env:esp32-ota-freertos-minimal]
extends = env:esp32-ota-freertos
build_flags = 
    ${env:esp32-ota-freertos.build_flags}
    -Os  ; Optimize for size
    -D CONFIG_FREERTOS_ASSERT_DISABLE=1
    -D NDEBUG
    -D OTA_TASK_STACK_SIZE=3072
    -D APP_TASK_STACK_SIZE=4096
board_build.stack_size = 4096