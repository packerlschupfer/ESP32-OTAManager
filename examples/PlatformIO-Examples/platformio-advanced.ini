; Advanced PlatformIO configuration for OTAManager
; With multiple environments and build configurations

[platformio]
default_envs = esp32-ota-dev
extra_configs = 
    platformio-secrets.ini  ; Store sensitive data separately

; Shared configuration for all environments
[env]
platform = espressif32
framework = arduino
lib_deps = 
    OTAManager
    throwtheswitch/Unity@^2.5.2  ; For testing
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    colorize
    time
    default

; Common build flags
build_flags = 
    -D OTA_LOG_DEBUG(format, ...)='Serial.printf("[OTA-D] " format "\\n", ##__VA_ARGS__)'
    -D OTA_LOG_INFO(format, ...)='Serial.printf("[OTA-I] " format "\\n", ##__VA_ARGS__)'
    -D OTA_LOG_WARN(format, ...)='Serial.printf("[OTA-W] " format "\\n", ##__VA_ARGS__)'
    -D OTA_LOG_ERROR(format, ...)='Serial.printf("[OTA-E] " format "\\n", ##__VA_ARGS__)'

; Development environment with verbose debugging
[env:esp32-ota-dev]
board = esp32dev
build_type = debug
build_flags = 
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_ESP_OTA
    -D OTA_HOSTNAME=\"esp32-dev\"
    -D OTA_PASSWORD=\"dev123\"
    -D OTA_CHECK_INTERVAL_MS=1000
    -D OTA_LOG_INTERVAL_MS=10000
upload_protocol = esptool
upload_speed = 921600

; Production environment with optimizations
[env:esp32-ota-prod]
board = esp32dev
build_type = release
build_flags = 
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=1
    -O2  ; Optimize for speed
    -D OTA_HOSTNAME=\"esp32-prod\"
    -D OTA_PASSWORD=\"${sysenv.OTA_PROD_PASSWORD}\"  ; From environment variable
    -D OTA_CHECK_INTERVAL_MS=500
    -D NDEBUG  ; Disable assertions
upload_protocol = espota
upload_port = esp32-prod.local
upload_flags = 
    --port=3232
    --auth=${sysenv.OTA_PROD_PASSWORD}

; ESP32-S3 with PSRAM support
[env:esp32s3-ota]
board = esp32s3devkitc1
build_flags = 
    ${env.build_flags}
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D OTA_HOSTNAME=\"esp32s3-ota\"
    -D OTA_PASSWORD=\"s3-update\"
    -mfix-esp32-psram-cache-issue
board_build.partitions = default_16MB.csv
board_build.flash_size = 16MB
board_build.psram = enabled

; ESP32-C3 RISC-V variant
[env:esp32c3-ota]
board = esp32c3devkitm1
build_flags = 
    ${env.build_flags}
    -D OTA_HOSTNAME=\"esp32c3-ota\"
    -D OTA_PASSWORD=\"c3-update\"
    -D CONFIG_ESP32C3_DEFAULT_CPU_FREQ_160=y
board_build.flash_size = 4MB

; Environment for automated testing
[env:esp32-ota-test]
board = esp32dev
test_build_src = yes
build_flags = 
    ${env.build_flags}
    -D UNIT_TEST
    -D OTA_HOSTNAME=\"esp32-test\"
    -D OTA_PASSWORD=\"test123\"
test_ignore = test_manual/*

; Environment with custom partition table
[env:esp32-ota-custom-partition]
board = esp32dev
board_build.partitions = partitions_custom.csv
build_flags = 
    ${env.build_flags}
    -D OTA_HOSTNAME=\"esp32-custom\"
    -D OTA_PASSWORD=\"custom123\"

; Create custom partition file: partitions_custom.csv
; # Name,   Type, SubType, Offset,  Size,    Flags
; nvs,      data, nvs,     0x9000,  0x4000
; otadata,  data, ota,     0xd000,  0x2000
; phy_init, data, phy,     0xf000,  0x1000
; app0,     app,  ota_0,   0x10000, 0x1E0000
; app1,     app,  ota_1,   0x1F0000,0x1E0000
; spiffs,   data, spiffs,  0x3D0000,0x30000

; Multi-environment build for different deployment targets
[env:esp32-ota-multi]
board = esp32dev
build_flags = 
    ${env.build_flags}
    !echo "-D BUILD_ENV=\"${PIOENV}\""
    !echo "-D BUILD_TIME=\"$(date +'%%Y-%%m-%%d %%H:%%M:%%S')\""
    !echo "-D GIT_COMMIT=\"$(git rev-parse --short HEAD)\""
    -D OTA_HOSTNAME=\"esp32-${PIOENV}\"

; Environment with SSL/TLS support (future enhancement)
[env:esp32-ota-secure]
board = esp32dev
lib_deps = 
    ${env.lib_deps}
    arduino-libraries/ArduinoOTA@^1.0.9
    bblanchon/ArduinoJson@^6.21.3
build_flags = 
    ${env.build_flags}
    -D OTA_HOSTNAME=\"esp32-secure\"
    -D OTA_USE_SSL=1
    -D MBEDTLS_KEY_EXCHANGE_RSA_PSK_ENABLED
    -D MBEDTLS_KEY_EXCHANGE_RSA_ENABLED