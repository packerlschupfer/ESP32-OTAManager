; Production-ready PlatformIO configuration for OTAManager
; With security, monitoring, and deployment best practices

[platformio]
default_envs = esp32-ota-production
extra_configs = 
    platformio-secrets.ini  ; Keep secrets separate

; Base production configuration
[env:esp32-ota-production]
platform = espressif32@6.4.0  ; Pin platform version
board = esp32dev
framework = arduino

lib_deps = 
    OTAManager@^1.0.1  ; Pin library version
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8  ; For MQTT monitoring

; Production build flags
build_flags = 
    -D CORE_DEBUG_LEVEL=1  ; Minimal logging
    -O2  ; Optimize for speed
    -D NDEBUG  ; Disable assertions
    ; Version information
    -D APP_VERSION=\"1.0.0\"
    -D BUILD_TIMESTAMP=${sysenv.BUILD_TIMESTAMP}
    -D GIT_COMMIT=\"${sysenv.GIT_COMMIT}\"
    ; Network configuration from environment
    -D WIFI_SSID=\"${sysenv.PROD_WIFI_SSID}\"
    -D WIFI_PASSWORD=\"${sysenv.PROD_WIFI_PASS}\"
    ; OTA configuration
    -D OTA_HOSTNAME=\"prod-${sysenv.DEVICE_ID}\"
    -D OTA_PASSWORD=\"${sysenv.PROD_OTA_PASS}\"
    -D OTA_PORT=3232
    ; Security settings
    -D ENABLE_SECURE_BOOT=1
    -D ENABLE_FLASH_ENCRYPTION=1
    ; Monitoring
    -D MQTT_SERVER=\"${sysenv.MQTT_SERVER}\"
    -D MQTT_PORT=8883  ; TLS port
    -D MQTT_USER=\"${sysenv.MQTT_USER}\"
    -D MQTT_PASS=\"${sysenv.MQTT_PASS}\"
    -D TELEMETRY_ENABLED=1
    ; Watchdog settings
    -D WDT_TIMEOUT_SECONDS=30
    -D ENABLE_TASK_WDT=1

; Production partition table
board_build.partitions = partitions_production.csv
board_build.flash_size = 4MB
board_build.f_cpu = 240000000L

; Code signing (requires ESP-IDF)
; board_build.code_signing_key = keys/signing_key.pem

monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    default

; Production upload via OTA only
upload_protocol = espota
upload_port = ${sysenv.DEVICE_IP}
upload_flags = 
    --port=3232
    --auth=${sysenv.PROD_OTA_PASS}
    --timeout=60
    --retry=3

; Extra scripts for production workflow
extra_scripts = 
    pre:scripts/pre_build.py
    post:scripts/post_build.py

; Staging environment (pre-production testing)
[env:esp32-ota-staging]
extends = env:esp32-ota-production
build_flags = 
    ${env:esp32-ota-production.build_flags}
    -D ENVIRONMENT=\"staging\"
    -D CORE_DEBUG_LEVEL=3  ; More logging for staging
    -D OTA_HOSTNAME=\"stg-${sysenv.DEVICE_ID}\"
    -D MQTT_SERVER=\"staging.mqtt.server\"
    -D ENABLE_BETA_FEATURES=1

; Production with rollback support
[env:esp32-ota-production-rollback]
extends = env:esp32-ota-production
build_flags = 
    ${env:esp32-ota-production.build_flags}
    -D ENABLE_ROLLBACK=1
    -D ROLLBACK_TIMEOUT_SECONDS=300
    -D HEALTH_CHECK_ENABLED=1
    -D HEALTH_CHECK_INTERVAL=60000

; Factory partition for recovery
board_build.partitions = partitions_factory.csv

; High availability production config
[env:esp32-ota-production-ha]
extends = env:esp32-ota-production
board = esp32dev  ; Or esp32s3devkitc1 for more resources

build_flags = 
    ${env:esp32-ota-production.build_flags}
    ; Dual network support
    -D USE_WIFI=1
    -D USE_ETHERNET=1
    -D NETWORK_FAILOVER_ENABLED=1
    ; Enhanced monitoring
    -D HEARTBEAT_INTERVAL=30000
    -D METRICS_COLLECTION_ENABLED=1
    -D PROMETHEUS_EXPORTER_ENABLED=1
    -D PROMETHEUS_PORT=9090
    ; Resource monitoring
    -D MONITOR_HEAP_USAGE=1
    -D MONITOR_STACK_USAGE=1
    -D MONITOR_CPU_USAGE=1
    ; Self-healing features
    -D AUTO_RESTART_ON_FAILURE=1
    -D MAX_RESTART_ATTEMPTS=3
    -D RESTART_BACKOFF_MS=60000

lib_deps = 
    ${env:esp32-ota-production.lib_deps}
    esp32m/ESP32-metrics@^1.0.0

; Secure production with certificate validation
[env:esp32-ota-production-secure]
extends = env:esp32-ota-production
build_flags = 
    ${env:esp32-ota-production.build_flags}
    ; TLS/SSL settings
    -D USE_TLS=1
    -D VERIFY_SERVER_CERTIFICATE=1
    -D CA_CERT_BUNDLE=\"${sysenv.CA_CERT_PATH}\"
    -D CLIENT_CERT=\"${sysenv.CLIENT_CERT_PATH}\"
    -D CLIENT_KEY=\"${sysenv.CLIENT_KEY_PATH}\"
    ; Enhanced security
    -D ENABLE_SECURE_ELEMENT=1
    -D USE_HARDWARE_CRYPTO=1
    -D ENCRYPT_NVS=1
    ; Secure OTA
    -D OTA_USE_HTTPS=1
    -D OTA_SERVER=\"${sysenv.OTA_SERVER_URL}\"
    -D OTA_VERIFY_SIGNATURE=1

lib_deps = 
    ${env:esp32-ota-production.lib_deps}
    ESP32HTTPUpdate@^2.1.145

; Fleet deployment configuration
[env:esp32-ota-fleet]
extends = env:esp32-ota-production
build_flags = 
    ${env:esp32-ota-production.build_flags}
    ; Fleet management
    -D FLEET_ID=\"${sysenv.FLEET_ID}\"
    -D DEVICE_GROUP=\"${sysenv.DEVICE_GROUP}\"
    -D UPDATE_CHANNEL=\"${sysenv.UPDATE_CHANNEL}\"
    ; Staggered updates
    -D STAGGERED_UPDATE_ENABLED=1
    -D UPDATE_WINDOW_START=2  ; 2 AM
    -D UPDATE_WINDOW_END=5    ; 5 AM
    -D UPDATE_CHECK_INTERVAL=3600000  ; 1 hour
    ; A/B testing support
    -D AB_TESTING_ENABLED=1
    -D EXPERIMENT_ID=\"${sysenv.EXPERIMENT_ID}\"

; Create partitions_production.csv:
; # Production partition table with OTA and factory reset
; # Name,   Type, SubType, Offset,  Size,    Flags
; nvs,      data, nvs,     0x9000,  0x5000,
; otadata,  data, ota,     0xe000,  0x2000,
; app0,     app,  ota_0,   0x10000, 0x1A0000,
; app1,     app,  ota_1,   0x1B0000,0x1A0000,
; factory,  app,  factory, 0x350000,0x80000,
; spiffs,   data, spiffs,  0x3D0000,0x30000,